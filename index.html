<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>블루투스 마이크</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        }
        .card-container {
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(45, 55, 72, 0.6);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 relative">

<div class="max-w-md w-full p-6 sm:p-8 bg-gray-800 rounded-2xl shadow-xl border border-gray-700 text-center relative z-10 card-container">
    <h1 class="text-3xl sm:text-4xl font-bold mb-2">블루투스 마이크</h1>
    <p class="text-lg text-gray-400 mb-6">블루투스 스피커와 연결하여 사용하세요.</p>
    
    <!-- 상태 메시지 -->
    <div id="statusMessage" class="mb-4 text-center">
        <p class="text-lg text-red-400 font-semibold" id="connectionStatus">블루투스 스피커를 연결해 주세요.</p>
    </div>

    <!-- 메인 컨트롤 버튼 -->
    <div class="mb-4">
        <button id="startButton" class="w-full py-4 px-6 bg-purple-600 hover:bg-purple-700 transition-colors duration-200 rounded-xl text-lg font-semibold text-white shadow-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50" disabled>
            마이크 켜기
        </button>
        <button id="stopButton" class="w-full py-4 px-6 bg-red-600 hover:bg-red-700 transition-colors duration-200 rounded-xl text-lg font-semibold text-white shadow-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 hidden">
            마이크 끄기
        </button>
    </div>
</div>

<script>
    // 전역 변수 설정
    let audioContext;
    let microphone;
    let stream;
    let isMicOn = false;

    // UI 요소 가져오기
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const statusMessage = document.getElementById('connectionStatus');

    // 마이크 시작 함수
    async function startMic() {
        if (isMicOn) return;
        startButton.disabled = true;

        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            await audioContext.resume();

            // 블루투스 스피커가 연결되어 있는지 확인
            const outputDevices = await navigator.mediaDevices.enumerateDevices();
            const bluetoothSpeaker = outputDevices.find(device => device.kind === 'audiooutput' && device.label.toLowerCase().includes('bluetooth'));

            if (!bluetoothSpeaker) {
                statusMessage.textContent = '블루투스 스피커를 먼저 연결해 주세요.';
                statusMessage.classList.add('text-red-400');
                statusMessage.classList.remove('text-green-400');
                startButton.disabled = false;
                return;
            }

            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            microphone = audioContext.createMediaStreamSource(stream);

            // 마이크 입력 -> 오디오 출력으로 바로 연결
            microphone.connect(audioContext.destination);

            isMicOn = true;
            startButton.classList.add('hidden');
            stopButton.classList.remove('hidden');
            statusMessage.textContent = '마이크가 켜졌습니다.';
            statusMessage.classList.remove('text-red-400');
            statusMessage.classList.add('text-green-400');
        } catch (error) {
            console.error('마이크 접근 오류:', error);
            startButton.disabled = false;
            statusMessage.textContent = "마이크를 켤 수 없습니다. 권한을 확인해 주세요.";
            statusMessage.classList.add('text-red-400');
            statusMessage.classList.remove('text-green-400');
            isMicOn = false;
            startButton.classList.remove('hidden');
            stopButton.classList.add('hidden');
        }
    }

    // 마이크 중지 함수
    function stopMic() {
        if (!isMicOn) return;

        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        if (audioContext) {
            audioContext.close();
            audioContext = null;
        }
        
        isMicOn = false;
        startButton.classList.remove('hidden');
        stopButton.classList.add('hidden');
        
        statusMessage.textContent = "마이크가 꺼졌습니다.";
        statusMessage.classList.remove('text-green-400');
        statusMessage.classList.add('text-red-400');
    }

    // 블루투스 연결 상태를 확인하고 버튼을 활성화하는 함수
    async function checkBluetoothStatus() {
        const outputDevices = await navigator.mediaDevices.enumerateDevices();
        const bluetoothSpeaker = outputDevices.find(device => device.kind === 'audiooutput' && device.label.toLowerCase().includes('bluetooth'));

        if (bluetoothSpeaker) {
            startButton.disabled = false;
            statusMessage.textContent = '블루투스 스피커가 연결되었습니다. 마이크를 켤 수 있습니다.';
            statusMessage.classList.remove('text-red-400');
            statusMessage.classList.add('text-green-400');
        } else {
            startButton.disabled = true;
            statusMessage.textContent = '블루투스 스피커를 연결해 주세요.';
            statusMessage.classList.remove('text-green-400');
            statusMessage.classList.add('text-red-400');
        }
    }

    startButton.addEventListener('click', startMic);
    stopButton.addEventListener('click', stopMic);
    window.addEventListener('beforeunload', () => stopMic());

    // 페이지 로드 시 블루투스 상태 확인
    window.onload = () => {
        checkBluetoothStatus();
        // 장치 변경이 있을 때마다 상태 다시 확인
        navigator.mediaDevices.addEventListener('devicechange', checkBluetoothStatus);
    };
</script>

</body>
</html>
